name: CI

on:
  pull_request:
  push:
    branches: [main]

permissions:
  contents: read

concurrency:
  group: ci-${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  lint:
    name: lint
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: pip
          cache-dependency-path: pyproject.toml
      - name: Run lint gate
        run: make lint

  typecheck:
    name: typecheck
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: pip
          cache-dependency-path: pyproject.toml
      - name: Run typecheck gate
        run: make typecheck

  arch-contracts:
    name: arch-contracts
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: pip
          cache-dependency-path: pyproject.toml
      - name: Run architecture contracts gate
        run: make arch

  ci-contracts:
    name: ci-contracts
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: pip
          cache-dependency-path: pyproject.toml
      - name: Run CI contracts gate
        run: make ci-contracts

  tests-core:
    name: tests-core
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: pip
          cache-dependency-path: pyproject.toml
      - name: Run core tests
        run: make tests PYTEST_XML=pytest-core.xml
      - name: Upload core test report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: pytest-core-report
          path: pytest-core.xml

  tests-full:
    name: tests-full
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: pip
          cache-dependency-path: pyproject.toml
      - name: Run full tests (with optional deps)
        run: make tests-full PYTEST_XML=pytest-full.xml
      - name: Upload full test report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: pytest-full-report
          path: pytest-full.xml

  package-smoke:
    name: package-smoke
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: pip
          cache-dependency-path: pyproject.toml
      - name: Run packaging smoke gate
        run: make package-smoke
      - name: Upload distribution artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: dist-packages
          path: dist/
